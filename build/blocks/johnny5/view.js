(()=>{"use strict";const e="text/event-stream",t="last-event-id";function n(n,r){var{signal:a,headers:i,onopen:s,onmessage:c,onclose:d,onerror:l,openWhenHidden:u,fetch:b}=r,y=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n}(r,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise(((r,h)=>{const f=Object.assign({},i);let v;function m(){v.abort(),document.hidden||E()}f.accept||(f.accept=e),u||document.addEventListener("visibilitychange",m);let p=1e3,w=0;function g(){document.removeEventListener("visibilitychange",m),window.clearTimeout(w),v.abort()}null==a||a.addEventListener("abort",(()=>{g(),r()}));const O=null!=b?b:window.fetch,j=null!=s?s:o;async function E(){var e;v=new AbortController;try{const e=await O(n,Object.assign(Object.assign({},y),{headers:f,signal:v.signal}));await j(e),await async function(e,t){const n=e.getReader();let o;for(;!(o=await n.read()).done;)t(o.value)}(e.body,function(e){let t,n,o,r=!1;return function(a){void 0===t?(t=a,n=0,o=-1):t=function(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}(t,a);const i=t.length;let s=0;for(;n<i;){r&&(10===t[n]&&(s=++n),r=!1);let a=-1;for(;n<i&&-1===a;++n)switch(t[n]){case 58:-1===o&&(o=n-s);break;case 13:r=!0;case 10:a=n}if(-1===a)break;e(t.subarray(s,a),o),s=n,o=-1}s===i?t=void 0:0!==s&&(t=t.subarray(s),n-=s)}}(function(e,n,o){let r={data:"",event:"",id:"",retry:void 0};const a=new TextDecoder;return function(e,n){if(0===e.length)null==o||o(r),r={data:"",event:"",id:"",retry:void 0};else if(n>0){const o=a.decode(e.subarray(0,n)),s=n+(32===e[n+1]?2:1),c=a.decode(e.subarray(s));switch(o){case"data":r.data=r.data?r.data+"\n"+c:c;break;case"event":r.event=c;break;case"id":(i=r.id=c)?f[t]=i:delete f[t];break;case"retry":const e=parseInt(c,10);isNaN(e)||(e=>{p=e})(r.retry=e)}}var i}}(0,0,c))),null==d||d(),g(),r()}catch(t){if(!v.signal.aborted)try{const n=null!==(e=null==l?void 0:l(t))&&void 0!==e?e:p;window.clearTimeout(w),w=window.setTimeout(E,n)}catch(e){g(),h(e)}}}E()}))}function o(t){const n=t.headers.get("content-type");if(!(null==n?void 0:n.startsWith(e)))throw new Error(`Expected content-type to be ${e}, Actual: ${n}`)}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("[data-johnny5-form]");if(!e)return;const t=e.querySelector('[type="submit"]');let o;e.addEventListener("submit",(async r=>{r.preventDefault(),o&&o.remove(),e.setAttribute("data-johnny5-form","loading"),t.setAttribute("disabled","disabled");const a=new FormData(e),i=Array.from(a.keys()).reduce(((e,t)=>{const n=t.match(/(\w+)\[(\w+)\]/);if(n){var o;const[,r,i]=n;e[r]=null!==(o=e[r])&&void 0!==o?o:{},e[r][i]=a.get(t)}else e[t]=a.get(t);return e}),{}),s=document.createElement("p");o=document.createElement("div"),o.setAttribute("data-johnny5-response",""),o.appendChild(s),e.parentNode.appendChild(o);const c=new AbortController;try{await n(`${johnny5.restUrl}johnny5/v1/completion`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":a.get("_wpnonce")},body:JSON.stringify(i),onmessage(n){if("[DONE]"===n.data)return c.abort(),e.setAttribute("data-johnny5-form","success"),void t.removeAttribute("disabled");'"\\n"'===n.data?s.textContent.length>0&&(s.textContent+="\r\n"):s.textContent+=JSON.parse(n.data)},onclose(){throw new Error},onerror(){throw new Error},signal:c.signal})}catch(n){e.setAttribute("data-johnny5-form","error"),o.innerHTML="Something went wrong.",t.removeAttribute("disabled")}}))}))})();